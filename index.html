<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥å» ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --bg: #f4f6f8; --card-bg: #fff; }
        body { font-family: -apple-system, Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; touch-action: manipulation; }
        
        .page { display: none; padding: 10px; }
        .page.active { display: block; }
        
        .card { background: var(--card-bg); padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        
        .label { font-size: 13px; color: #666; display: block; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-weight: bold; background: #fff;}
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .qty-input { width: 100%; font-size: 48px; font-weight: 800; color: var(--primary); text-align: center; border: none; background: transparent; margin: 5px 0; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-op { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-minus { background: #dc3545; }
        .btn-plus { background: #198754; }
        .btn-plus-10 { background: #0d6efd; }

        .btn-submit { width: 100%; background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 20px; font-weight: bold; margin-top: 10px; cursor:pointer;}
        .btn-search { width: 100%; background: #0056b3; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 18px; margin-top: 10px; cursor:pointer;}
        
        /* åº«å­˜ä¿®æ­£æŒ‰éˆ• */
        .btn-correct { width: 100%; background: #ff9800; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 16px; margin-top: 5px; cursor:pointer; font-weight: bold;}

        .btn-small-load { background: #17a2b8; color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 14px; cursor: pointer; float: right; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; height: 60px; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12px; color: #999; cursor: pointer; border-top: 4px solid transparent; }
        .nav-item.active { color: var(--primary); font-weight: bold; border-top-color: var(--primary); background: #f8f9fa; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .dash-item { background: #f0f7ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; }
        .dash-title { font-size: 12px; color: #666; }
        
        /* æŸ¥è©¢é çš„å¤§åº«å­˜è¼¸å…¥æ¡† */
        .dash-val-input { width: 100%; font-size: 32px; font-weight: bold; color: var(--primary); text-align: center; border: none; background: transparent; border-bottom: 2px solid var(--primary); }

        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .history-table th { background: #eee; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;}
        .history-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: white; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; backdrop-filter: blur(2px); }
    </style>
</head>
<body>
    <div id="loading"><div style="font-size: 40px;">ğŸ”„</div><div style="margin-top:10px;">è™•ç†ä¸­...</div></div>

    <div id="page-input" class="page active">
        <div class="header">
            <div>ğŸ“ ç”Ÿç”¢å›å ±</div>
            <div class="clock">12:00</div>
        </div>

        <div class="card info-grid">
            <div style="grid-column: span 2;">
                <span class="label">ğŸ“¦ æ–™è™Ÿ (Part) 
                    <button class="btn-small-load" onclick="fetchStockForInput()">ğŸ”„ è®€å–åº«å­˜</button>
                </span>
                <input type="text" id="part" class="input-field" value="A-774">
            </div>
            
            <div><span class="label">ğŸ”– æ‰¹è™Ÿ (Batch)</span><input type="text" id="batch" class="input-field" value="LOT-01"></div>
            
            <div>
                <span class="label">ğŸ–¥ï¸ ç³»çµ±åº«å­˜</span>
                <input type="text" id="current-system-stock" class="input-field" value="-" readonly style="background:#e9ecef; color:#666; font-size:16px;">
            </div>

            <div><span class="label">ğŸ“¥ æœ¬æ¬¡é€²è²¨</span><input type="number" id="target" class="input-field" value="0" onclick="this.select()" oninput="previewNewStock()"></div>
            
            <div style="grid-column: span 2;">
                <span class="label">â±ï¸ é è¨ˆå®Œæˆæ™‚é–“ (YYYY/MM/DD HH:mm)</span>
                <input type="datetime-local" id="ect" class="input-field">
            </div>
        </div>

        <div class="card" style="text-align:center;">
            <span class="label">âœ… æœ¬æ¬¡å®Œæˆæ•¸é‡</span>
            <input type="number" id="qty" class="qty-input" value="0" onclick="this.select()" oninput="previewNewStock()">
            <div class="btn-group">
                <button class="btn-op btn-minus" onclick="adjQty(-1)">-1</button>
                <button class="btn-op btn-plus" onclick="adjQty(1)">+1</button>
                <button class="btn-op btn-plus-10" onclick="adjQty(10)">+10</button>
            </div>
            
            <div style="margin-top: 15px; border-top:1px solid #eee; padding-top:10px;">
                <span class="label">ğŸ­ æ›´æ–°å¾Œåº«å­˜ (å¯æ‰‹å‹•ä¿®æ­£)</span>
                <input type="number" id="final-stock" class="input-field" style="background:#fffbe6; color:var(--primary); font-size:24px; text-align:center;" value="0">
            </div>
        </div>

        <div style="padding:0 10px;">
            <button class="btn-submit" onclick="submitData()">ğŸ’¾ æäº¤è³‡æ–™</button>
        </div>
    </div>

    <div id="page-query" class="page">
        <div class="header" style="background:#555;">
            <div>ğŸ” åº«å­˜ç¸½è¦½</div>
            <div class="clock">12:00</div>
        </div>

        <div class="card">
            <span class="label">è¼¸å…¥æ–™è™ŸæŸ¥è©¢</span>
            <input type="text" id="q-part" class="input-field" placeholder="æ–™è™Ÿ (å¦‚ A-774)">
            <button class="btn-search" onclick="queryData()">æŸ¥è©¢</button>
        </div>

        <div id="result-area" class="card" style="display:none; border-top: 5px solid #0056b3;">
            <h3 style="margin-top:0; color:#333;">ğŸ“Š ç›®å‰ç‹€æ…‹</h3>
            
            <div class="dashboard-grid">
                <div class="dash-item">
                    <div class="dash-title">æœ€å¾Œæ›´æ–°</div>
                    <div class="dash-val" id="res-date" style="font-size:16px; color:#666;">-</div>
                </div>
                
                <div class="dash-item" style="background:#e3f2fd; border-color:#90caf9;">
                    <div class="dash-title">ç›®å‰åº«å­˜ (å¯ä¿®æ”¹)</div>
                    <input type="number" id="res-stock-input" class="dash-val-input" value="0">
                </div>
            </div>
            
            <button class="btn-correct" onclick="correctStockFromQuery()">ğŸ› ï¸ å„²å­˜åº«å­˜ä¿®æ­£</button>
            <p style="font-size:12px; color:#666; text-align:center;">*è‹¥ç™¼ç¾åº«å­˜ä¸ç¬¦ï¼Œè«‹ç›´æ¥ä¿®æ”¹æ•¸å­—ä¸¦æŒ‰æ©˜è‰²æŒ‰éˆ•</p>

            <h4 style="margin-bottom:5px; margin-top:20px; border-bottom:1px solid #eee;">ğŸ“œ è©³ç´°æ­·å² (å«æ™‚é–“)</h4>
            <div style="overflow-x:auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>åº«å­˜</th>
                            <th>é€²è²¨/å®Œæˆ</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('input', this)"><div class="nav-icon">ğŸ“</div>å›å ±</div>
        <div class="nav-item" onclick="switchPage('query', this)"><div class="nav-icon">ğŸ”</div>æŸ¥è©¢</div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Script ç¶²å€
        // ==========================================
        const URL = "https://script.google.com/macros/s/AKfycbym1ulu27l_8gCThjYV6CbTUS8mv4CaXEGxCM-aNzO4aqNaghO1ib0XCnztCUOqCL0/exec"; 
        // ==========================================

        function initTime() {
            const now = new Date();
            const y = now.getFullYear();
            const m = (now.getMonth()+1).toString().padStart(2,'0');
            const d = now.getDate().toString().padStart(2,'0');
            const h = now.getHours().toString().padStart(2,'0');
            const min = now.getMinutes().toString().padStart(2,'0');
            document.getElementById('ect').value = `${y}-${m}-${d}T${h}:${min}`;
        }
        initTime();

        function updateClock() {
            const t = new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'});
            document.querySelectorAll('.clock').forEach(el => el.innerText = t);
        }
        setInterval(updateClock, 1000); updateClock();

        function switchPage(pageName, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        let systemStock = 0; 

        // è®€å–åº«å­˜ (è¼¸å…¥é ç”¨)
        function fetchStockForInput() {
            if(!URL) return alert("è«‹è¨­å®šç¶²å€");
            let p = document.getElementById('part').value.trim();
            if(!p) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");

            toggleLoad(true);
            document.getElementById('current-system-stock').value = "...";

            fetch(`${URL}?partNo=${encodeURIComponent(p)}&batchNo=`)
            .then(r => r.json())
            .then(data => {
                toggleLoad(false);
                if(data.found) {
                    systemStock = data.currentStock; // æŠ“æœ€å¾Œä¸€ç­†çš„åº«å­˜
                    document.getElementById('current-system-stock').value = systemStock;
                    previewNewStock(); 
                } else {
                    systemStock = 0;
                    document.getElementById('current-system-stock').value = "0";
                    previewNewStock();
                }
            })
            .catch(e => { toggleLoad(false); alert("é€£ç·šéŒ¯èª¤"); });
        }

        function previewNewStock() {
            let t = parseInt(document.getElementById('target').value) || 0;
            let q = parseInt(document.getElementById('qty').value) || 0;
            let estimated = systemStock + t - q;
            document.getElementById('final-stock').value = estimated;
        }

        function adjQty(n) {
            let el = document.getElementById('qty');
            let v = parseInt(el.value) || 0;
            if(v + n >= 0) { el.value = v + n; previewNewStock(); }
        }

        function toggleLoad(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // æäº¤å›å ± (ä¸€èˆ¬ä½œæ¥­)
        function submitData() {
            if(!URL || URL.includes("è²¼ä¸Š")) return alert("è«‹è¨­å®šç¶²å€");
            toggleLoad(true);

            let t = parseInt(document.getElementById('target').value) || 0;
            let q = parseInt(document.getElementById('qty').value) || 0;
            let finalStock = document.getElementById('final-stock').value; // é€™æ˜¯äººå“¡ç¢ºèªéçš„åº«å­˜

            const payload = {
                partNo: document.getElementById('part').value,
                batchNo: document.getElementById('batch').value,
                target: t,
                qty: q,
                stock: finalStock, 
                ect: document.getElementById('ect').value
            };
            
            fetch(URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) })
            .then(() => {
                toggleLoad(false); alert("âœ… è³‡æ–™å·²æäº¤ï¼");
                document.getElementById('qty').value = 0;
                document.getElementById('target').value = 0;
                fetchStockForInput(); 
            }).catch(e => { toggleLoad(false); alert("é€£ç·šå¤±æ•—"); });
        }

        // æŸ¥è©¢åº«å­˜
        function queryData() {
            if(!URL) return alert("è«‹è¨­å®šç¶²å€");
            let p = document.getElementById('q-part').value.trim();
            if(!p) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");

            toggleLoad(true);
            document.getElementById('result-area').style.display = 'none';

            fetch(`${URL}?partNo=${encodeURIComponent(p)}&batchNo=`) 
            .then(r => r.json())
            .then(data => {
                toggleLoad(false);
                if(data.found) {
                    // é¡¯ç¤ºæœ€å¾Œæ›´æ–°æ™‚é–“ (æ ¼å¼åŒ–)
                    let dStr = "-";
                    try {
                        let d = new Date(data.lastUpdated);
                        dStr = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
                    } catch(e){}

                    document.getElementById('res-date').innerText = dStr;
                    document.getElementById('res-stock-input').value = data.currentStock; // å¡«å…¥è¼¸å…¥æ¡†

                    // ç”¢ç”Ÿæ­·å²è¡¨æ ¼
                    const tbody = document.getElementById('history-tbody');
                    tbody.innerHTML = "";
                    data.history.forEach(row => {
                        let submitTime = row.time;
                        try {
                            let d = new Date(row.time);
                            let y = d.getFullYear();
                            let m = (d.getMonth()+1).toString().padStart(2,'0');
                            let day = d.getDate().toString().padStart(2,'0');
                            let h = d.getHours().toString().padStart(2,'0');
                            let min = d.getMinutes().toString().padStart(2,'0');
                            submitTime = `${y}/${m}/${day} ${h}:${min}`;
                        } catch(e){}

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-size:12px;">${submitTime}</td>
                                <td style="font-size:14px; font-weight:bold;">${row.stock}</td>
                                <td><span style="color:#999;">${row.target}</span> / <span style="color:var(--success);">${row.qty}</span></td>
                            </tr>
                        `;
                    });
                    document.getElementById('result-area').style.display = 'block';
                } else {
                    alert("âŒ æŸ¥ç„¡æ­¤æ–™è™Ÿè³‡æ–™");
                }
            }).catch(e => { toggleLoad(false); alert("æŸ¥è©¢å¤±æ•—ï¼š" + e); });
        }

        // å¾æŸ¥è©¢é é¢ç›´æ¥ã€Œæ ¡æ­£åº«å­˜ã€
        function correctStockFromQuery() {
            let p = document.getElementById('q-part').value.trim();
            let newStock = document.getElementById('res-stock-input').value; // æŠ“å–äººå“¡ä¿®æ”¹å¾Œçš„æ•¸å­—

            if(!p) return;
            if(!confirm(`ç¢ºå®šè¦å°‡æ–™è™Ÿ ${p} çš„åº«å­˜ä¿®æ­£ç‚º ${newStock} å—ï¼Ÿ`)) return;

            toggleLoad(true);
            const payload = {
                partNo: p,
                batchNo: "ç›¤é»ä¿®æ­£", // è‡ªå‹•æ¨™è¨˜ç‚ºç›¤é»
                target: 0,
                qty: 0,
                stock: newStock, // é€™æ˜¯æ–°çš„æ­£ç¢ºåº«å­˜
                ect: ""
            };

            fetch(URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) })
            .then(() => {
                toggleLoad(false); 
                alert("âœ… åº«å­˜å·²ä¿®æ­£å®Œç•¢ï¼");
                queryData(); // é‡æ–°æ•´ç†é¡¯ç¤º
            }).catch(e => { toggleLoad(false); alert("é€£ç·šå¤±æ•—"); });
        }
    </script>
</body>
</html>
