<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥å» ä½œæ¥­ç³»çµ±</title>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --bg: #f4f6f8; }
        body { font-family: -apple-system, Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; touch-action: manipulation; }
        
        .page { padding: 10px; }
        .card { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold;}
        
        .label { font-size: 13px; color: #666; display: block; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-weight: bold; background: #fff;}
        
        /* è‡ªå‹•è¨ˆç®—æ¬„ä½æ¨£å¼ */
        .auto-calc { background-color: #e8f5e9; color: #1b5e20; border-color: #a5d6a7; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* å®Œæˆæ•¸é‡å¤§è¼¸å…¥æ¡† */
        .qty-input { width: 100%; font-size: 48px; font-weight: 800; color: var(--primary); text-align: center; border: none; background: transparent; margin: 5px 0; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; }
        .btn-op { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-minus { background: #dc3545; }
        .btn-plus { background: #198754; }
        .btn-plus-10 { background: #0d6efd; }

        .btn-submit { width: 100%; background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .btn-search { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 18px; margin-top: 10px; cursor: pointer; }

        /* æ­·å²è¡¨æ ¼ */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .history-table th { background: #eee; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;}
        .history-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: white; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; backdrop-filter: blur(2px); }
    </style>
</head>
<body>
    <div id="loading"><div style="font-size: 40px;">ğŸ”„</div><div style="margin-top:10px;">è®€å–ä¸­...</div></div>

    <div class="page">
        <div class="header">
            <div>ğŸ­ ç¾å ´ç”Ÿç”¢å›å ±</div>
            <div id="clock">12:00:00</div>
        </div>

        <div class="card" style="border-left: 5px solid #0056b3;">
            <span class="label">ğŸ” æ­¥é©Ÿä¸€ï¼šè¼¸å…¥æ–™è™Ÿèª¿é–±éå»è³‡æ–™</span>
            <div class="info-grid">
                <input type="text" id="q-part" class="input-field" placeholder="æ–™è™Ÿ (å¦‚ A-774)">
                <input type="text" id="q-batch" class="input-field" placeholder="æ‰¹è™Ÿ (é¸å¡«)">
            </div>
            <button class="btn-search" onclick="queryData()">æŸ¥è©¢ä¸¦è¼‰å…¥è¨­å®š</button>
        </div>

        <div class="card" id="work-area">
            <h3 style="margin-top:0; color:#0056b3; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“ æ­¥é©ŸäºŒï¼šä¿®æ­£ç”Ÿç”¢ç‹€æ³</h3>
            
            <div class="info-grid">
                <div><span class="label">ğŸ“¦ æ–™è™Ÿ</span><input type="text" id="part" class="input-field" readonly style="background:#f0f0f0;"></div>
                <div><span class="label">ğŸ”– æ‰¹è™Ÿ</span><input type="text" id="batch" class="input-field" readonly style="background:#f0f0f0;"></div>
                
                <div>
                    <span class="label">ğŸ“¥ é€²è²¨æ•¸é‡ (Target)</span>
                    <input type="number" id="target" class="input-field" value="0" oninput="autoCalc()" onclick="this.select()">
                </div>
                <div>
                    <span class="label">ğŸ­ åº«å­˜ (Target - Qty)</span>
                    <input type="number" id="stock" class="input-field auto-calc" readonly value="0">
                </div>
            </div>

            <div style="text-align:center; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <span class="label">âœ… ç´¯è¨ˆå®Œæˆæ•¸é‡ (ä¿®æ”¹æ­¤è™•)</span>
                <input type="number" id="qty" class="qty-input" value="0" oninput="autoCalc()" onclick="this.select()">
                
                <div class="btn-group">
                    <button class="btn-op btn-minus" onclick="adjQty(-1)">-1</button>
                    <button class="btn-op btn-plus" onclick="adjQty(1)">+1</button>
                    <button class="btn-op btn-plus-10" onclick="adjQty(10)">+10</button>
                </div>
            </div>

            <div style="margin-top:10px;">
                <span class="label">â±ï¸ é è¨ˆå®Œæˆæ™‚é–“</span>
                <input type="time" id="ect" class="input-field" value="17:00">
            </div>

            <button class="btn-submit" onclick="submitData()" style="margin-top:15px;">ğŸ’¾ æäº¤æ›´æ–° (æ–°å¢ä¸€ç­†ç´€éŒ„)</button>
        </div>

        <div class="card" id="history-area" style="display:none;">
            <h3 style="margin-top:0; color:#666;">ğŸ“Š æ­·å²ç´€éŒ„åˆ—è¡¨</h3>
            <div style="overflow-x:auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“ (å¹´æœˆæ—¥)</th>
                            <th>å®Œæˆ</th>
                            <th>åº«å­˜</th>
                            <th>é€²è²¨</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Script ç¶²å€
        // ==========================================
        const URL = "https://script.google.com/macros/s/AKfycbym1ulu27l_8gCThjYV6CbTUS8mv4CaXEGxCM-aNzO4aqNaghO1ib0XCnztCUOqCL0/exec"; 
        // ==========================================

        function updateClock() {
            // é€™è£¡çš„æ™‚é–“åƒ…ä¾›é¡¯ç¤ºï¼Œå¯«å…¥è³‡æ–™åº«çš„æ™‚é–“ç”±å¾Œç«¯æ±ºå®š
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-TW', {hour12:false});
        }
        setInterval(updateClock, 1000); updateClock();

        function toggleLoad(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // --- è‡ªå‹•è¨ˆç®—åº«å­˜ ---
        function autoCalc() {
            let target = parseInt(document.getElementById('target').value) || 0;
            let qty = parseInt(document.getElementById('qty').value) || 0;
            // é‚è¼¯ï¼šåº«å­˜ = é€²è²¨ç¸½é‡ - å·²å®Œæˆ
            document.getElementById('stock').value = target - qty;
        }

        // æŒ‰éˆ•åŠ æ¸›
        function adjQty(n) {
            let el = document.getElementById('qty');
            let v = parseInt(el.value) || 0;
            if(v + n >= 0) {
                el.value = v + n;
                autoCalc(); // è§¸ç™¼è¨ˆç®—
            }
        }

        // --- æŸ¥è©¢åŠŸèƒ½ ---
        function queryData() {
            if(!URL || URL.includes("è²¼ä¸Š")) return alert("è«‹å…ˆè¨­å®šç¶²å€ï¼");
            
            let p = document.getElementById('q-part').value.trim();
            let b = document.getElementById('q-batch').value.trim();
            if(!p) return alert("è«‹è¼¸å…¥æ–™è™Ÿ");

            toggleLoad(true);
            document.getElementById('history-area').style.display = 'none';

            fetch(`${URL}?partNo=${encodeURIComponent(p)}&batchNo=${encodeURIComponent(b)}`)
            .then(r => r.json())
            .then(data => {
                toggleLoad(false);
                if(data.found) {
                    // 1. è¼‰å…¥æœ€æ–°è³‡æ–™åˆ°ä½œæ¥­å€
                    document.getElementById('part').value = data.latest.part;
                    document.getElementById('batch').value = data.latest.batch;
                    document.getElementById('target').value = data.latest.target;
                    document.getElementById('qty').value = data.latest.qty;
                    // æ™‚é–“åªå–å‰5ç¢¼ (HH:mm) çµ¦è¼¸å…¥æ¡†ç”¨ï¼Œå› ç‚º input type="time" ä¸æ”¯æ´æ—¥æœŸ
                    if(data.latest.ect) document.getElementById('ect').value = data.latest.ect.substring(0,5);
                    
                    // åŸ·è¡Œè¨ˆç®—ä»¥æ›´æ–°åº«å­˜
                    autoCalc();

                    // 2. é¡¯ç¤ºæ­·å²è¡¨æ ¼
                    renderHistoryTable(data.history);
                } else {
                    alert("âŒ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªæ–™è™Ÿã€‚");
                    // æ²’æŸ¥åˆ°ä¹ŸæŠŠæ–™è™Ÿå¡«é€²å»ï¼Œæ–¹ä¾¿ç›´æ¥é–‹å·¥
                    document.getElementById('part').value = p;
                    document.getElementById('batch').value = b;
                }
            }).catch(e => {
                toggleLoad(false); alert("æŸ¥è©¢å¤±æ•—ï¼š" + e);
            });
        }

        // --- æ¸²æŸ“æ­·å²è¡¨æ ¼ (å«å¹´æœˆæ—¥) ---
        function renderHistoryTable(list) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = ""; 

            list.forEach(row => {
                // è™•ç†æ—¥æœŸæ ¼å¼
                let timeDisplay = row.time;
                try {
                    // å˜—è©¦è§£ææ—¥æœŸå­—ä¸²
                    let dateObj = new Date(row.time);
                    if (!isNaN(dateObj.getTime())) {
                        // æ ¼å¼åŒ–ç‚º: 2026/01/06 14:30
                        let y = dateObj.getFullYear();
                        let m = (dateObj.getMonth()+1).toString().padStart(2, '0');
                        let d = dateObj.getDate().toString().padStart(2, '0');
                        let h = dateObj.getHours().toString().padStart(2, '0');
                        let min = dateObj.getMinutes().toString().padStart(2, '0');
                        timeDisplay = `${y}/${m}/${d} ${h}:${min}`;
                    }
                } catch(e) {
                    // å¦‚æœè§£æå¤±æ•—å°±ç›´æ¥é¡¯ç¤ºåŸå§‹å­—ä¸²
                }

                let tr = `
                    <tr>
                        <td style="font-size:12px;">${timeDisplay}</td>
                        <td style="color:var(--primary); font-weight:bold;">${row.qty}</td>
                        <td>${row.stock}</td>
                        <td style="color:#666;">${row.target}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
            document.getElementById('history-area').style.display = 'block';
        }

        // --- æäº¤è³‡æ–™ ---
        function submitData() {
            toggleLoad(true);
            const payload = {
                partNo: document.getElementById('part').value,
                batchNo: document.getElementById('batch').value,
                target: document.getElementById('target').value,
                qty: document.getElementById('qty').value,
                stock: document.getElementById('stock').value,
                ect: document.getElementById('ect').value
            };
            
            fetch(URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            }).then(() => {
                toggleLoad(false); 
                alert("âœ… è³‡æ–™å·²æäº¤æ›´æ–°ï¼");
                queryData(); // æäº¤å¾Œè‡ªå‹•é‡æ–°æ•´ç†æ­·å²è¡¨
            }).catch(e => { toggleLoad(false); alert("é€£ç·šå¤±æ•—"); });
        }
    </script>
</body>
</html>
